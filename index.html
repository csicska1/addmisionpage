<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code Admission Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; text-align:center; background:#f4f4f4; }
    h1 { margin-top:20px; }
    #scanner-container { width:100%; max-width:400px; margin:20px auto; border:2px solid #333; border-radius:10px; background:#fff; min-height:260px; display:flex; align-items:center; justify-content:center; }
    button { padding:10px 20px; margin:10px 5px; font-size:16px; cursor:pointer; border-radius:5px; border:none; background:#007bff; color:#fff; }
    button:disabled { background:gray; cursor:not-allowed; }
    #scan-history { max-width:400px; margin:20px auto; text-align:left; background:#fff; padding:10px; border-radius:10px; border:1px solid #ccc; }
    .pass { color:green; }
    .denied { color:red; }
    #loader-msg { color:#666; }
  </style>
</head>
<body>
  <h1>QR Code Admission Scanner</h1>
  <div id="scanner-container">
    <div id="loader-msg">Waiting for camera / scanner library...</div>
  </div>

  <div>
    <button id="start-scan">Start Scanning</button>
    <button id="stop-scan" disabled>Stop Scanning</button>
    <button id="clear-history">Clear History</button>
  </div>

  <div id="scan-history">
    <h3>Scan History</h3>
    <ul id="history-list"></ul>
  </div>

  <script>
    // Try multiple sources; prefer CDNs but fall back to a local file served from the same origin
    const fallbackUrls = [
      "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js",
      "https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js",
      "/js/html5-qrcode.min.js" // local copy you must provide on your server
    ];

    function loadScriptSequential(urls, cb) {
      let i = 0;
      function next() {
        if (window.Html5Qrcode) return cb(null);
        if (i >= urls.length) return cb(new Error("All script sources failed"));
        const s = document.createElement("script");
        s.src = urls[i++];
        s.async = true;
        s.onload = () => {
          // if the library defines the global, succeed; otherwise try next
          if (window.Html5Qrcode) return cb(null);
          next();
        };
        s.onerror = () => next();
        document.head.appendChild(s);
      }
      next();
    }

    loadScriptSequential(fallbackUrls, function(err) {
      const loaderMsg = document.getElementById("loader-msg");
      if (err || typeof window.Html5Qrcode !== "function") {
        console.error("Html5Qrcode failed to load. Check network/CSP/ORB or provide a local copy at /js/html5-qrcode.min.js.", err);
        if (loaderMsg) loaderMsg.textContent = "Scanner library failed to load. See console for details.";
        return;
      }
      if (loaderMsg && loaderMsg.parentNode) loaderMsg.parentNode.removeChild(loaderMsg);
      initScanner();
    });

    function initScanner() {
      const containerId = "scanner-container";
      const startButton = document.getElementById("start-scan");
      const stopButton = document.getElementById("stop-scan");
      const clearButton = document.getElementById("clear-history");
      const historyList = document.getElementById("history-list");

      const beepSound = new Audio("https://www.soundjay.com/buttons/sounds/beep-07.mp3");

      let html5Qrcode;
      try {
        html5Qrcode = new Html5Qrcode(containerId);
      } catch (e) {
        console.error("Failed to instantiate Html5Qrcode", e);
        document.getElementById(containerId).appendChild(Object.assign(document.createElement("div"), {textContent:"Unable to create scanner. See console."}));
        startButton.disabled = true;
        stopButton.disabled = true;
        return;
      }

      function giveFeedback() {
        beepSound.play().catch(()=>{});
        if (navigator.vibrate) navigator.vibrate(200);
      }

      startButton.addEventListener("click", () => {
        startButton.disabled = true;
        const constraints = { facingMode: { ideal: "environment" } };
        html5Qrcode.start(
          constraints,
          { fps: 10, qrbox: Math.min(300, Math.floor(window.innerWidth * 0.8)) },
          qrCodeMessage => {
            const li = document.createElement("li");
            if (typeof qrCodeMessage === "string" && qrCodeMessage.toLowerCase().includes("pass")) {
              li.textContent = `✅ ${qrCodeMessage}`;
              li.classList.add("pass");
            } else {
              li.textContent = `❌ ${qrCodeMessage}`;
              li.classList.add("denied");
            }
            historyList.prepend(li);
            giveFeedback();
          },
          errorMessage => {}
        ).then(() => {
          startButton.disabled = true;
          stopButton.disabled = false;
        }).catch(err => {
          console.error("start() failed:", err);
          alert("Unable to start scanning: " + err);
          startButton.disabled = false;
        });
      });

      stopButton.addEventListener("click", () => {
        stopButton.disabled = true;
        html5Qrcode.stop().then(() => {
          startButton.disabled = false;
          stopButton.disabled = true;
        }).catch(err => {
          console.error("stop() failed:", err);
          alert("Unable to stop scanning: " + err);
          stopButton.disabled = false;
        });
      });

      clearButton.addEventListener("click", () => historyList.innerHTML = "");

      window.addEventListener("beforeunload", () => {
        try { html5Qrcode && html5Qrcode.getState && html5Qrcode.getState() === Html5Qrcode.ScannerState.SCANNING && html5Qrcode.stop(); } catch (e) {}
      });
    }
  </script>
</body>
</html>
