<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Code Access Control</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; padding:20px; background:#f0f0f0; }
  h1 { color:#333; }
  input { padding:10px; width:200px; }
  button { padding:10px 20px; margin:5px; cursor:pointer; }
  #qr-canvas { margin-top:10px; border:1px solid #ccc; }
  #qr-reader { width:300px; margin:20px auto; display:none; }
  #result { margin:15px; font-size:1.2em; font-weight:bold; }
  #result.pass { color:green; }
  #result.denied { color:red; }
  #scan-history { list-style:none; padding:0; max-height:200px; overflow-y:auto; border:1px solid #ccc; margin:10px auto; width:300px; background:#fff; }
  #scan-history li { padding:5px; border-bottom:1px solid #eee; text-align:left; }
</style>

<!-- QR Code library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<!-- Html5 QR code scanner library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>

<h1>QR Code Access Control</h1>

<!-- QR code generation -->
<div>
  <input type="text" id="qr-text" placeholder="Enter code to generate">
  <button onclick="generateQR()">Generate QR</button>
  <canvas id="qr-canvas"></canvas>
</div>

<hr>

<!-- QR code scanning -->
<div>
  <button id="start-scan">Scan QR Code</button>
  <div id="qr-reader"></div>
</div>

<div id="result"></div>

<h3>Scan History</h3>
<ul id="scan-history"></ul>

<script>
  // ---------- Allowed codes ----------
  let allowedCodes = ["ALLOWED123","VIP_PASS","EMPLOYEE_001"];

  // ---------- Generate QR ----------
  function generateQR(){
    const text = document.getElementById("qr-text").value.trim();
    if(!text){ alert("Enter a code"); return; }
    const canvas = document.getElementById("qr-canvas");
    QRCode.toCanvas(canvas, text, {width:200}, function (error) {
      if(error) console.error(error);
    });
  }

  // ---------- Scan History ----------
  function addHistory(code,status){
    const ul = document.getElementById("scan-history");
    const li = document.createElement("li");
    const time = new Date().toLocaleTimeString();
    li.textContent = `[${time}] ${code} - ${status}`;
    ul.prepend(li);
  }

  // ---------- Display scan result ----------
  function showResult(status,message,code){
    const resDiv = document.getElementById("result");
    resDiv.textContent = message;
    resDiv.className = status;
    addHistory(code,message);
  }

  // ---------- QR Scanner ----------
  let html5QrCode;
  let scanning = false;

  function onScanSuccess(decodedText){
    if(allowedCodes.includes(decodedText)){
      showResult("pass","✅ Access Granted",decodedText);
    } else {
      showResult("denied","❌ Access Denied",decodedText);
    }
  }

  function onScanFailure(error){ /* ignore scan failures */ }

  document.getElementById("start-scan").addEventListener("click", function(){
    if(scanning) return; // prevent multiple starts
    scanning = true;
    const readerDiv = document.getElementById("qr-reader");
    readerDiv.style.display = "block";

    html5QrCode = new Html5Qrcode("qr-reader");

    Html5Qrcode.getCameras().then(cameras => {
      if(cameras && cameras.length){
        const cameraId = cameras[0].id;
        html5QrCode.start(
          cameraId,
          {fps:10, qrbox:250},
          onScanSuccess,
          onScanFailure
        ).catch(err=>{
          showResult("denied","❌ Camera not accessible","");
          console.error(err);
        });
      } else showResult("denied","❌ No camera found","");
    }).catch(err=>{
      showResult("denied","❌ Cannot access camera","");
      console.error(err);
    });
  });
</script>

</body>
</html>
